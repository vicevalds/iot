# Configuración de Apache2 con proxy inverso HTTP (sin SSL)

ServerName localhost

# Cargar módulos necesarios
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule filter_module modules/mod_filter.so

# Configuración básica
ServerRoot "/usr/local/apache2"
Listen 80

User www-data
Group www-data

# Ocultar versión de Apache
ServerTokens Prod
ServerSignature Off

# Logging
ErrorLog /proc/self/fd/2
LogLevel warn
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog /proc/self/fd/1 combined

# Tipos MIME
TypesConfig conf/mime.types

# Tamaño máximo de carga
LimitRequestBody 10485760

# Compresión Gzip
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xml+rss
</IfModule>

# Servidor HTTP con proxy inverso
<VirtualHost *:80>
    ServerName localhost

    # Headers de seguridad básicos
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Timeouts
    ProxyTimeout 60
    Timeout 60

    # Configuración de proxy para WebSockets
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://app:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://app:3000/$1 [P,L]

    # Proxy principal a la aplicación
    ProxyPreserveHost On
    ProxyPass / http://app:3000/ upgrade=websocket
    ProxyPassReverse / http://app:3000/

    # Headers de proxy
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Configuración específica para /api/
    <Location /api/>
        ProxyPass http://app:3000/api/
        ProxyPassReverse http://app:3000/api/
    </Location>

    # Logs
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
