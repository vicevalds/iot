# Configuración completa de Apache2 con SSL y proxy inverso
# Equivalente a nginx.conf con Let's Encrypt

ServerName iot.vicevalds.dev

# Cargar módulos necesarios
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule http2_module modules/mod_http2.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule filter_module modules/mod_filter.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so

# Configuración básica
ServerRoot "/usr/local/apache2"
Listen 80
Listen 443

User www-data
Group www-data

# Ocultar versión de Apache (equivalente a server_tokens off)
ServerTokens Prod
ServerSignature Off

# Logging
ErrorLog /proc/self/fd/2
LogLevel warn
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog /proc/self/fd/1 combined

# Tipos MIME
TypesConfig conf/mime.types

# Tamaño máximo de carga (equivalente a client_max_body_size)
LimitRequestBody 10485760

# Compresión Gzip (equivalente a gzip en nginx)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xml+rss
</IfModule>

# Configuración SSL moderna (siguiendo las mejores prácticas)
<IfModule mod_ssl.c>
    SSLEngine on
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # OCSP Stapling para mejor rendimiento SSL
    SSLUseStapling on
    SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

    # Configuración de sesiones SSL
    SSLSessionCache "shmcb:logs/ssl_scache(512000)"
    SSLSessionCacheTimeout 300
    SSLSessionTickets off
</IfModule>

# Servidor HTTP - Redirección a HTTPS
<VirtualHost *:80>
    ServerName iot.vicevalds.dev

    # Directorio para Let's Encrypt challenge
    DocumentRoot /var/www/certbot

    # Permitir acceso al challenge de Let's Encrypt
    <Directory /var/www/certbot>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    <Location /.well-known/acme-challenge/>
        Options -Indexes
        Require all granted
    </Location>

    # Redirigir todo lo demás a HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{SERVER_NAME}$1 [R=301,L]
</VirtualHost>

# Servidor HTTPS con SSL y proxy reverso
<VirtualHost *:443>
    ServerName iot.vicevalds.dev

    # Habilitar HTTP/2
    Protocols h2 http/1.1

    # Certificados SSL de Let's Encrypt
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/iot.vicevalds.dev/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/iot.vicevalds.dev/privkey.pem

    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Headers de seguridad adicionales
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Timeouts (equivalente a proxy timeouts en nginx)
    ProxyTimeout 60
    Timeout 60

    # Configuración de proxy para WebSockets
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://app:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://app:3000/$1 [P,L]

    # Proxy principal a la aplicación
    ProxyPreserveHost On
    ProxyPass / http://app:3000/ upgrade=websocket
    ProxyPassReverse / http://app:3000/

    # Headers de proxy (equivalente a proxy_set_header en nginx)
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Configuración específica para /api/ con rate limiting
    # Nota: Apache no tiene rate limiting tan avanzado como nginx por defecto
    # Se requeriría mod_qos o mod_evasive para implementarlo completamente
    <Location /api/>
        ProxyPass http://app:3000/api/
        ProxyPassReverse http://app:3000/api/
    </Location>

    # Logs específicos del virtual host
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
